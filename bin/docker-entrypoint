#!/bin/bash -e

# If running the rails server then create or migrate existing database,
# and ensure SolidQueue tables exist (they use db/queue_schema.rb, not migrations).
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  ./bin/rails db:prepare
  bundle exec rails runner "
    unless ActiveRecord::Base.connection.table_exists?('solid_queue_jobs')
      load Rails.root.join('db/queue_schema.rb')
    end
  "
fi

exec "${@}"
